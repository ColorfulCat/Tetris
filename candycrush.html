<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ°´æœæ¶ˆæ¶ˆä¹</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      touch-action: manipulation;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      overflow: hidden;
      position: relative;
    }
    
    .game-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      position: relative;
      z-index: 10;
    }
    
    .score-section {
      display: flex;
      gap: 30px;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .score-box {
      background: rgba(0, 0, 0, 0.6);
      border-radius: 15px;
      padding: 15px 25px;
      text-align: center;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
      min-width: 120px;
    }
    
    .score-title {
      font-size: 14px;
      color: #a0a0a0;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .score-value {
      font-size: 28px;
      font-weight: bold;
      color: #fff;
    }
    
    .game-board {
      background: rgba(0, 0, 0, 0.6);
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
      padding: 15px;
      position: relative;
    }
    
    #gameBoard {
      width: 400px;
      height: 400px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      position: relative;
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      grid-template-rows: repeat(8, 1fr);
      gap: 2px;
      padding: 5px;
    }
    
    .grid-cell {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 8px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .grid-cell:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
    }
    
    .grid-cell.selected {
      background: rgba(255, 255, 0, 0.8);
      transform: scale(1.1);
      box-shadow: 0 0 20px rgba(255, 255, 0, 0.8);
    }
    
    .grid-cell.matched {
      animation: matchAnimation 0.4s ease-in-out;
    }
    
    @keyframes matchAnimation {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.2);
        opacity: 0.7;
      }
      100% {
        transform: scale(0);
        opacity: 0;
      }
    }
    
    .fruit {
      font-size: 32px;
      transition: none;
      pointer-events: none;
    }
    
    .fruit.new-fruit {
      animation: fruitAppear 0.3s ease-out;
    }
    
    @keyframes fruitAppear {
      0% {
        transform: scale(0) rotate(180deg);
        opacity: 0;
      }
      100% {
        transform: scale(1) rotate(0deg);
        opacity: 1;
      }
    }
    
    .new-game-btn {
      padding: 15px 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 25px;
      font-size: 18px;
      font-weight: bold;
      color: white;
      text-align: center;
      box-shadow: 
        0 8px 25px rgba(102, 126, 234, 0.4),
        inset 0 2px 4px rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .new-game-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }
    
    .new-game-btn:hover {
      transform: translateY(-3px);
      box-shadow: 
        0 12px 35px rgba(102, 126, 234, 0.6),
        inset 0 2px 4px rgba(255, 255, 255, 0.3);
      background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    }
    
    .new-game-btn:hover::before {
      left: 100%;
    }
    
    .new-game-btn:active {
      transform: translateY(-1px) scale(0.98);
    }
    
    .game-over {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 20;
      display: none;
    }
    
    .game-over h2 {
      font-size: 48px;
      color: #ff4d4d;
      margin-bottom: 30px;
      text-shadow: 0 0 10px rgba(255, 77, 77, 0.5);
    }
    
    .final-score {
      font-size: 32px;
      margin-bottom: 30px;
    }
    
    .restart-btn {
      padding: 18px 50px;
      background: linear-gradient(to right, #ff416c, #ff4b2b);
      border-radius: 30px;
      font-size: 22px;
      font-weight: bold;
      color: white;
      box-shadow: 0 8px 25px rgba(255, 75, 43, 0.4);
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .restart-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 35px rgba(255, 75, 43, 0.6);
    }
    
    /* èƒŒæ™¯åŠ¨ç”» */
    .background {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      z-index: 1;
    }
    
    .shape {
      position: absolute;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 50%;
      animation: float 20s infinite linear;
    }
    
    @keyframes float {
      0% {
        transform: translateY(0) rotate(0deg);
      }
      100% {
        transform: translateY(-100vh) rotate(360deg);
      }
    }
    
    .combo-text {
      position: absolute;
      font-size: 24px;
      font-weight: bold;
      color: #ffff00;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      animation: comboAnimation 1s ease-out;
      pointer-events: none;
      z-index: 15;
    }
    
    @keyframes comboAnimation {
      0% {
        transform: scale(0.5) translateY(0);
        opacity: 1;
      }
      50% {
        transform: scale(1.2) translateY(-20px);
        opacity: 1;
      }
      100% {
        transform: scale(1) translateY(-50px);
        opacity: 0;
      }
    }
    
    /* ç§»åŠ¨ç«¯é€‚é… */
    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      
      .game-container {
        gap: 15px;
        width: 100%;
        max-width: 100vw;
      }
      
      #gameBoard {
        width: min(90vw, 380px);
        height: min(90vw, 380px);
        padding: 3px;
        gap: 1px;
      }
      
      .score-section {
        gap: 15px;
        flex-wrap: wrap;
        justify-content: center;
        width: 100%;
      }
      
      .score-box {
        min-width: 90px;
        padding: 10px 15px;
        flex: 1;
        max-width: 120px;
      }
      
      .score-title {
        font-size: 12px;
      }
      
      .score-value {
        font-size: 20px;
      }
      
      .fruit {
        font-size: 28px;
      }
      
      .grid-cell {
        min-height: 40px;
        border-radius: 6px;
      }
      
      .new-game-btn {
        padding: 12px 30px;
        font-size: 16px;
        width: 80%;
        max-width: 200px;
      }
      
      .confirm-content {
        margin: 20px;
        padding: 25px;
        max-width: 280px;
      }
      
      .confirm-title {
        font-size: 20px;
      }
      
      .confirm-message {
        font-size: 14px;
      }
      
      .confirm-btn {
        padding: 10px 20px;
        font-size: 14px;
        min-width: 70px;
      }
    }
    
    /* è¶…å°å±å¹•é€‚é… */
    @media (max-width: 360px) {
      #gameBoard {
        width: min(95vw, 320px);
        height: min(95vw, 320px);
      }
      
      .score-section {
        gap: 10px;
      }
      
      .score-box {
        min-width: 80px;
        padding: 8px 12px;
      }
      
      .score-title {
        font-size: 11px;
      }
      
      .score-value {
        font-size: 18px;
      }
      
      .fruit {
        font-size: 24px;
      }
      
      .new-game-btn {
        padding: 10px 25px;
        font-size: 14px;
      }
    }
    
    /* æ¨ªå±é€‚é… */
    @media (max-width: 768px) and (orientation: landscape) {
      body {
        padding: 5px;
      }
      
      .game-container {
        gap: 10px;
      }
      
      #gameBoard {
        width: min(60vh, 350px);
        height: min(60vh, 350px);
      }
      
      .score-section {
        gap: 15px;
      }
      
      .score-box {
        padding: 8px 15px;
      }
      
      .score-value {
        font-size: 20px;
      }
    }
    
    /* å¤§å±æ‰‹æœºé€‚é… */
    @media (min-width: 481px) and (max-width: 768px) {
      #gameBoard {
        width: min(70vw, 450px);
        height: min(70vw, 450px);
      }
      
      .fruit {
        font-size: 36px;
      }
      
      .grid-cell {
        min-height: 50px;
      }
    }
    
    /* ç¡®è®¤å¼¹çª—æ ·å¼ */
    .confirm-dialog {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 30;
      display: none;
    }
    
    .confirm-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
      max-width: 320px;
      width: 90%;
    }
    
    .confirm-title {
      font-size: 24px;
      font-weight: bold;
      color: white;
      margin-bottom: 15px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .confirm-message {
      font-size: 16px;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 25px;
      line-height: 1.4;
    }
    
    .confirm-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
    }
    
    .confirm-btn {
      padding: 12px 25px;
      border-radius: 15px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 80px;
    }
    
    .confirm-btn.yes {
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      color: white;
      box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
    }
    
    .confirm-btn.yes:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
    }
    
    .confirm-btn.no {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }
    
    .confirm-btn.no:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }
    
    /* æ·»åŠ æ‘‡æ‘†åŠ¨ç”» */
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
  </style>
</head>
<body>
  <div class="background" id="background"></div>
  
  <div class="game-container">
    <!-- åˆ†æ•°åŒºåŸŸ -->
    <div class="score-section">
      <div class="score-box">
        <div class="score-title">åˆ†æ•°</div>
        <div class="score-value" id="score">0</div>
      </div>
      
      <div class="score-box">
        <div class="score-title">æœ€é«˜åˆ†</div>
        <div class="score-value" id="highScore">0</div>
      </div>
      
      <div class="score-box">
        <div class="score-title">ç§»åŠ¨æ¬¡æ•°</div>
        <div class="score-value" id="moves">0</div>
      </div>
    </div>
    
    <!-- æ¸¸æˆé¢æ¿ -->
    <div class="game-board">
      <div id="gameBoard"></div>
    </div>
    
    <!-- æ–°æ¸¸æˆæŒ‰é’® -->
    <button class="new-game-btn" id="newGameBtn">æ–°æ¸¸æˆ</button>
  </div>
  
  <div class="game-over" id="gameOver">
    <h2>æ¸¸æˆç»“æŸ!</h2>
    <div class="final-score">æœ€ç»ˆåˆ†æ•°: <span id="finalScore">0</span></div>
    <div class="final-score">ç§»åŠ¨æ¬¡æ•°: <span id="finalMoves">0</span></div>
    <button class="restart-btn" id="restartBtn">é‡æ–°å¼€å§‹</button>
  </div>
  
  <!-- ç¡®è®¤å¼¹çª— -->
  <div class="confirm-dialog" id="confirmDialog">
    <div class="confirm-content">
      <div class="confirm-title">ç¡®è®¤æ–°æ¸¸æˆ</div>
      <div class="confirm-message">å¼€å§‹æ–°æ¸¸æˆå°†æ¸…é™¤å½“å‰è¿›åº¦ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ</div>
      <div class="confirm-buttons">
        <button class="confirm-btn no" id="confirmNo">å–æ¶ˆ</button>
        <button class="confirm-btn yes" id="confirmYes">ç¡®å®š</button>
      </div>
    </div>
  </div>

  <script>
    // æ¸¸æˆçŠ¶æ€
    let board = [];
    let score = 0;
    let highScore = 0;
    let moves = 0;
    let selectedCell = null;
    let gameEnded = false;
    let isProcessing = false;
    let isClickLocked = false;
    
    // æ°´æœç±»å‹
    const fruits = ['ğŸ', 'ğŸŠ', 'ğŸŒ', 'ğŸ‡', 'ğŸ“', 'ğŸ¥', 'ğŸ‘', 'ğŸ¥­'];
    
    // è§¦æ‘¸ç›¸å…³å˜é‡
    let startX = 0;
    let startY = 0;
    let startCell = null;
    let touchStartTime = 0;
    
    // åˆå§‹åŒ–æ¸¸æˆ
    function init() {
      createBackground();
      loadHighScore();
      setupEventListeners();
      newGame();
    }
    
    // åˆ›å»ºåŠ¨æ€èƒŒæ™¯
    function createBackground() {
      const bg = document.getElementById('background');
      const colors = [
        'rgba(255,182,193,0.1)',
        'rgba(255,218,185,0.1)', 
        'rgba(255,255,224,0.1)',
        'rgba(240,248,255,0.1)'
      ];
      
      for (let i = 0; i < 15; i++) {
        const shape = document.createElement('div');
        shape.classList.add('shape');
        
        // éšæœºå¤§å°
        const size = Math.random() * 80 + 40;
        shape.style.width = `${size}px`;
        shape.style.height = `${size}px`;
        
        // éšæœºä½ç½®
        shape.style.left = `${Math.random() * 100}%`;
        shape.style.top = `${Math.random() * 100}%`;
        
        // éšæœºé¢œè‰²
        shape.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        
        // éšæœºåŠ¨ç”»
        shape.style.animationDuration = `${Math.random() * 25 + 15}s`;
        shape.style.animationDelay = `${Math.random() * 5}s`;
        
        bg.appendChild(shape);
      }
    }
    
    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
      // æŒ‰é’®äº‹ä»¶
      document.getElementById('newGameBtn').addEventListener('click', showConfirmDialog);
      document.getElementById('restartBtn').addEventListener('click', newGame);
      document.getElementById('confirmYes').addEventListener('click', confirmNewGame);
      document.getElementById('confirmNo').addEventListener('click', hideConfirmDialog);
      
      // æ¸¸æˆæ¿è§¦æ‘¸äº‹ä»¶
      const gameBoard = document.getElementById('gameBoard');
      gameBoard.addEventListener('touchstart', handleGameBoardTouchStart, { passive: false });
      gameBoard.addEventListener('touchend', handleGameBoardTouchEnd, { passive: false });
      gameBoard.addEventListener('touchmove', handleGameBoardTouchMove, { passive: false });
    }
    
    // æ˜¾ç¤ºç¡®è®¤å¼¹çª—
    function showConfirmDialog() {
      if (score === 0 && moves === 0) {
        // å¦‚æœè¿˜æ²¡å¼€å§‹æ¸¸æˆï¼Œç›´æ¥å¼€å§‹æ–°æ¸¸æˆ
        newGame();
        return;
      }
      document.getElementById('confirmDialog').style.display = 'flex';
    }
    
    // éšè—ç¡®è®¤å¼¹çª—
    function hideConfirmDialog() {
      document.getElementById('confirmDialog').style.display = 'none';
    }
    
    // ç¡®è®¤æ–°æ¸¸æˆ
    function confirmNewGame() {
      hideConfirmDialog();
      newGame();
    }
    
    // æ¸¸æˆæ¿è§¦æ‘¸å¼€å§‹
    function handleGameBoardTouchStart(event) {
      event.preventDefault();
      if (isProcessing || gameEnded) return;
      
      const touch = event.touches[0];
      startX = touch.clientX;
      startY = touch.clientY;
      touchStartTime = Date.now();
      
      // æ‰¾åˆ°è§¦æ‘¸çš„å•å…ƒæ ¼
      const element = document.elementFromPoint(touch.clientX, touch.clientY);
      const cell = element.closest('.grid-cell');
      
      if (cell) {
        const row = parseInt(cell.dataset.row);
        const col = parseInt(cell.dataset.col);
        startCell = { row, col };
        
        // æ·»åŠ è§†è§‰åé¦ˆ
        highlightCell(row, col, true);
      }
    }
    
    // æ¸¸æˆæ¿è§¦æ‘¸ç§»åŠ¨
    function handleGameBoardTouchMove(event) {
      event.preventDefault();
    }
    
    // æ¸¸æˆæ¿è§¦æ‘¸ç»“æŸ
    function handleGameBoardTouchEnd(event) {
      event.preventDefault();
      if (isProcessing || gameEnded || !startCell || isClickLocked) return;
      
      const touch = event.changedTouches[0];
      const deltaX = touch.clientX - startX;
      const deltaY = touch.clientY - startY;
      const touchDuration = Date.now() - touchStartTime;
      const minSwipeDistance = 20; // è¿›ä¸€æ­¥é™ä½æœ€å°æ»‘åŠ¨è·ç¦»
      
      // æ¸…é™¤é«˜äº®
      highlightCell(startCell.row, startCell.col, false);
      
      let targetRow = startCell.row;
      let targetCol = startCell.col;
      let isSwipe = false;
      
      // åˆ¤æ–­æ˜¯å¦ä¸ºæ»‘åŠ¨æ“ä½œ
      const totalDistance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
      
      if (totalDistance > minSwipeDistance && touchDuration < 500) {
        // åˆ¤æ–­æ»‘åŠ¨æ–¹å‘
        if (Math.abs(deltaX) > Math.abs(deltaY)) {
          // æ°´å¹³æ»‘åŠ¨
          if (deltaX > 0 && startCell.col < 7) {
            targetCol = startCell.col + 1;
            isSwipe = true;
          } else if (deltaX < 0 && startCell.col > 0) {
            targetCol = startCell.col - 1;
            isSwipe = true;
          }
        } else {
          // å‚ç›´æ»‘åŠ¨
          if (deltaY > 0 && startCell.row < 7) {
            targetRow = startCell.row + 1;
            isSwipe = true;
          } else if (deltaY < 0 && startCell.row > 0) {
            targetRow = startCell.row - 1;
            isSwipe = true;
          }
        }
      }
      
      if (isSwipe) {
        // æ»‘åŠ¨äº¤æ¢
        attemptSwap(startCell.row, startCell.col, targetRow, targetCol);
      } else {
        // ç‚¹å‡»é€‰æ‹©
        handleCellClick(startCell.row, startCell.col);
      }
      
      startCell = null;
    }
    
    // æ–°æ¸¸æˆ
    function newGame() {
      board = [];
      score = 0;
      moves = 0;
      selectedCell = null;
      gameEnded = false;
      isProcessing = false;
      isClickLocked = false;
      
      // åˆå§‹åŒ–8x8æ£‹ç›˜
      initializeBoard();
      
      updateDisplay();
      document.getElementById('gameOver').style.display = 'none';
    }
    
    // åˆå§‹åŒ–æ£‹ç›˜ - æ›´ä¸¥è°¨çš„é€»è¾‘
    function initializeBoard() {
      let attempts = 0;
      const maxAttempts = 100;
      
      do {
        // é‡æ–°ç”Ÿæˆæ£‹ç›˜
        for (let i = 0; i < 8; i++) {
          board[i] = [];
          for (let j = 0; j < 8; j++) {
            board[i][j] = getRandomFruit();
          }
        }
        
        // ç§»é™¤åˆå§‹åŒ¹é…
        removeInitialMatches();
        attempts++;
        
        // é˜²æ­¢æ— é™å¾ªç¯
        if (attempts >= maxAttempts) {
          console.warn('åˆå§‹åŒ–æ£‹ç›˜è¾¾åˆ°æœ€å¤§å°è¯•æ¬¡æ•°');
          break;
        }
      } while (hasMatches() || !hasPossibleMoves());
    }
    
    // ç§»é™¤åˆå§‹åŒ¹é…
    function removeInitialMatches() {
      let hasInitialMatches = true;
      let safetyCounter = 0;
      
      while (hasInitialMatches && safetyCounter < 50) {
        hasInitialMatches = false;
        
        for (let i = 0; i < 8; i++) {
          for (let j = 0; j < 8; j++) {
            if (wouldCreateMatch(i, j, board[i][j])) {
              board[i][j] = getRandomFruit();
              hasInitialMatches = true;
            }
          }
        }
        safetyCounter++;
      }
    }
    
    // æ£€æŸ¥æ”¾ç½®æ°´æœæ˜¯å¦ä¼šåˆ›å»ºåŒ¹é…
    function wouldCreateMatch(row, col, fruit) {
      // æ£€æŸ¥æ°´å¹³åŒ¹é…
      let horizontalCount = 1;
      
      // å‘å·¦æ£€æŸ¥
      for (let j = col - 1; j >= 0 && board[row][j] === fruit; j--) {
        horizontalCount++;
      }
      
      // å‘å³æ£€æŸ¥
      for (let j = col + 1; j < 8 && board[row][j] === fruit; j++) {
        horizontalCount++;
      }
      
      if (horizontalCount >= 3) return true;
      
      // æ£€æŸ¥å‚ç›´åŒ¹é…
      let verticalCount = 1;
      
      // å‘ä¸Šæ£€æŸ¥
      for (let i = row - 1; i >= 0 && board[i][col] === fruit; i--) {
        verticalCount++;
      }
      
      // å‘ä¸‹æ£€æŸ¥
      for (let i = row + 1; i < 8 && board[i][col] === fruit; i++) {
        verticalCount++;
      }
      
      return verticalCount >= 3;
    }
    
    // è·å–éšæœºæ°´æœ
    function getRandomFruit() {
      return fruits[Math.floor(Math.random() * fruits.length)];
    }
    
    // æ›´æ–°æ˜¾ç¤º
    function updateDisplay(newFruits = []) {
      const gameBoard = document.getElementById('gameBoard');
      gameBoard.innerHTML = '';
      
      for (let i = 0; i < 8; i++) {
        for (let j = 0; j < 8; j++) {
          const cell = document.createElement('div');
          cell.className = 'grid-cell';
          cell.dataset.row = i;
          cell.dataset.col = j;
          
          const fruit = document.createElement('div');
          fruit.className = 'fruit';
          
          // åªå¯¹æ–°å¡«å……çš„æ°´æœæ·»åŠ åŠ¨ç”»
          const isNewFruit = newFruits.some(pos => pos.row === i && pos.col === j);
          if (isNewFruit) {
            fruit.classList.add('new-fruit');
          }
          
          fruit.textContent = board[i][j];
          
          cell.appendChild(fruit);
          
          // æ·»åŠ ç‚¹å‡»äº‹ä»¶
          cell.addEventListener('click', (e) => {
            e.preventDefault();
            handleCellClick(i, j);
          });
          
          gameBoard.appendChild(cell);
        }
      }
      
      // æ›´æ–°åˆ†æ•°æ˜¾ç¤º
      document.getElementById('score').textContent = score;
      document.getElementById('moves').textContent = moves;
      
      // æ£€æŸ¥å¹¶æ›´æ–°æœ€é«˜åˆ†
      if (score > highScore) {
        highScore = score;
        document.getElementById('highScore').textContent = highScore;
        saveHighScore();
      }
      
      // æ£€æŸ¥æ¸¸æˆçŠ¶æ€
      checkGameState();
    }
    
    // å¤„ç†å•å…ƒæ ¼ç‚¹å‡»
    function handleCellClick(row, col) {
      if (isProcessing || gameEnded || isClickLocked) return;
      
      if (selectedCell === null) {
        // é€‰æ‹©ç¬¬ä¸€ä¸ªå•å…ƒæ ¼
        selectedCell = { row, col };
        highlightCell(row, col, true);
      } else if (selectedCell.row === row && selectedCell.col === col) {
        // å–æ¶ˆé€‰æ‹©
        highlightCell(selectedCell.row, selectedCell.col, false);
        selectedCell = null;
      } else {
        // å°è¯•äº¤æ¢
        if (isAdjacent(selectedCell.row, selectedCell.col, row, col)) {
          attemptSwap(selectedCell.row, selectedCell.col, row, col);
        } else {
          // å¦‚æœä¸ç›¸é‚»ï¼Œé‡æ–°é€‰æ‹©
          highlightCell(selectedCell.row, selectedCell.col, false);
          selectedCell = { row, col };
          highlightCell(row, col, true);
          return;
        }
        
        // æ¸…é™¤é€‰æ‹©
        highlightCell(selectedCell.row, selectedCell.col, false);
        selectedCell = null;
      }
    }
    
    // é«˜äº®å•å…ƒæ ¼
    function highlightCell(row, col, highlight) {
      const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
      if (cell) {
        if (highlight) {
          cell.classList.add('selected');
        } else {
          cell.classList.remove('selected');
        }
      }
    }
    
    // æ£€æŸ¥ä¸¤ä¸ªå•å…ƒæ ¼æ˜¯å¦ç›¸é‚»
    function isAdjacent(row1, col1, row2, col2) {
      const rowDiff = Math.abs(row1 - row2);
      const colDiff = Math.abs(col1 - col2);
      return (rowDiff === 1 && colDiff === 0) || (rowDiff === 0 && colDiff === 1);
    }
    
    // ä¼˜åŒ–çš„äº¤æ¢å°è¯•å‡½æ•°
    function attemptSwap(row1, col1, row2, col2) {
      if (isProcessing || isClickLocked || gameEnded) return;
      
      // éªŒè¯äº¤æ¢çš„æœ‰æ•ˆæ€§
      if (!isValidSwap(row1, col1, row2, col2)) {
        return;
      }
      
      isProcessing = true;
      isClickLocked = true;
      
      // æ‰§è¡Œäº¤æ¢
      swapCells(row1, col1, row2, col2);
      
      // æ£€æŸ¥æ˜¯å¦æœ‰åŒ¹é…
      const matches = findMatches();
      
      if (matches.length > 0) {
        // æœ‰åŒ¹é…ï¼Œå¢åŠ ç§»åŠ¨æ¬¡æ•°
        moves++;
        updateDisplay();
        
        // å¤„ç†åŒ¹é…
        setTimeout(() => {
          processMatches();
        }, 150);
      } else {
        // æ²¡æœ‰åŒ¹é…ï¼Œäº¤æ¢å›æ¥
        swapCells(row1, col1, row2, col2);
        
        // æ˜¾ç¤ºæ— æ•ˆäº¤æ¢çš„è§†è§‰åé¦ˆ
        showInvalidSwapFeedback(row1, col1, row2, col2);
        
        // çŸ­æš‚å»¶è¿Ÿåè§£é”
        setTimeout(() => {
          isProcessing = false;
          isClickLocked = false;
        }, 300);
      }
    }
    
    // éªŒè¯äº¤æ¢æ˜¯å¦æœ‰æ•ˆ
    function isValidSwap(row1, col1, row2, col2) {
      // æ£€æŸ¥è¾¹ç•Œ
      if (row1 < 0 || row1 >= 8 || col1 < 0 || col1 >= 8 ||
          row2 < 0 || row2 >= 8 || col2 < 0 || col2 >= 8) {
        return false;
      }
      
      // æ£€æŸ¥æ˜¯å¦ç›¸é‚»
      return isAdjacent(row1, col1, row2, col2);
    }
    
    // äº¤æ¢å•å…ƒæ ¼
    function swapCells(row1, col1, row2, col2) {
      const temp = board[row1][col1];
      board[row1][col1] = board[row2][col2];
      board[row2][col2] = temp;
    }
    
    // æ˜¾ç¤ºæ— æ•ˆäº¤æ¢åé¦ˆ
    function showInvalidSwapFeedback(row1, col1, row2, col2) {
      const cell1 = document.querySelector(`[data-row="${row1}"][data-col="${col1}"]`);
      const cell2 = document.querySelector(`[data-row="${row2}"][data-col="${col2}"]`);
      
      if (cell1 && cell2) {
        cell1.style.animation = 'shake 0.3s ease-in-out';
        cell2.style.animation = 'shake 0.3s ease-in-out';
        
        setTimeout(() => {
          cell1.style.animation = '';
          cell2.style.animation = '';
        }, 300);
      }
    }
    
    // ä¼˜åŒ–çš„åŒ¹é…æŸ¥æ‰¾å‡½æ•°
    function findMatches() {
      const matches = new Set();
      
      // æ£€æŸ¥æ°´å¹³åŒ¹é… - æ›´ç²¾ç¡®çš„é€»è¾‘
      for (let i = 0; i < 8; i++) {
        let j = 0;
        while (j < 8) {
          const currentFruit = board[i][j];
          let count = 1;
          let startCol = j;
          
          // è®¡ç®—è¿ç»­ç›¸åŒæ°´æœçš„æ•°é‡
          while (j + count < 8 && board[i][j + count] === currentFruit) {
            count++;
          }
          
          // å¦‚æœæœ‰3ä¸ªæˆ–æ›´å¤šè¿ç»­çš„æ°´æœ
          if (count >= 3) {
            for (let k = 0; k < count; k++) {
              matches.add(`${i}-${startCol + k}`);
            }
          }
          
          j += count;
        }
      }
      
      // æ£€æŸ¥å‚ç›´åŒ¹é… - æ›´ç²¾ç¡®çš„é€»è¾‘
      for (let j = 0; j < 8; j++) {
        let i = 0;
        while (i < 8) {
          const currentFruit = board[i][j];
          let count = 1;
          let startRow = i;
          
          // è®¡ç®—è¿ç»­ç›¸åŒæ°´æœçš„æ•°é‡
          while (i + count < 8 && board[i + count][j] === currentFruit) {
            count++;
          }
          
          // å¦‚æœæœ‰3ä¸ªæˆ–æ›´å¤šè¿ç»­çš„æ°´æœ
          if (count >= 3) {
            for (let k = 0; k < count; k++) {
              matches.add(`${startRow + k}-${j}`);
            }
          }
          
          i += count;
        }
      }
      
      // è½¬æ¢ä¸ºå¯¹è±¡æ•°ç»„
      return Array.from(matches).map(key => {
        const [row, col] = key.split('-').map(Number);
        return { row, col };
      });
    }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰åŒ¹é…
    function hasMatches() {
      return findMatches().length > 0;
    }
    
    // ä¼˜åŒ–çš„åŒ¹é…å¤„ç†å‡½æ•°
    function processMatches() {
      const matches = findMatches();
      
      if (matches.length === 0) {
        // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å¯èƒ½çš„ç§»åŠ¨
        setTimeout(() => {
          checkGameState();
          isProcessing = false;
          isClickLocked = false;
        }, 100);
        return;
      }
      
      // è®¡ç®—åˆ†æ•° - æ›´åˆç†çš„è®¡åˆ†ç³»ç»Ÿ
      const baseScore = matches.length * 10;
      let comboMultiplier = 1;
      
      if (matches.length >= 4) comboMultiplier = 1.5;
      if (matches.length >= 5) comboMultiplier = 2;
      if (matches.length >= 6) comboMultiplier = 2.5;
      
      const totalScore = Math.floor(baseScore * comboMultiplier);
      score += totalScore;
      
      // æ˜¾ç¤ºè¿å‡»æ•ˆæœ
      if (matches.length >= 4) {
        showComboText(`${matches.length}è¿å‡»! +${totalScore}`);
      }
      
      // æ ‡è®°åŒ¹é…çš„å•å…ƒæ ¼
      matches.forEach(match => {
        const cell = document.querySelector(`[data-row="${match.row}"][data-col="${match.col}"]`);
        if (cell) {
          cell.classList.add('matched');
        }
      });
      
      // å»¶è¿Ÿåç§»é™¤åŒ¹é…çš„æ°´æœ
      setTimeout(() => {
        // ç§»é™¤åŒ¹é…çš„æ°´æœ
        matches.forEach(match => {
          board[match.row][match.col] = null;
        });
        
        // ä¸‹è½å’Œå¡«å……
        const newFruits = dropAndFill();
        
        // æ›´æ–°æ˜¾ç¤º
        updateDisplay(newFruits);
        
        // ç»§ç»­æ£€æŸ¥åŒ¹é…
        setTimeout(() => {
          processMatches();
        }, 200);
      }, 400);
    }
    
    // ä¼˜åŒ–çš„ä¸‹è½å’Œå¡«å……å‡½æ•°
    function dropAndFill() {
      const newFruits = [];
      
      // æ¯åˆ—å•ç‹¬å¤„ç†
      for (let j = 0; j < 8; j++) {
        // æ”¶é›†éç©ºæ°´æœ
        const column = [];
        for (let i = 7; i >= 0; i--) {
          if (board[i][j] !== null) {
            column.push(board[i][j]);
          }
        }
        
        // æ¸…ç©ºè¯¥åˆ—
        for (let i = 0; i < 8; i++) {
          board[i][j] = null;
        }
        
        // ä»åº•éƒ¨å¡«å……ç°æœ‰æ°´æœ
        for (let i = 0; i < column.length; i++) {
          board[7 - i][j] = column[i];
        }
        
        // ä»é¡¶éƒ¨å¡«å……æ–°æ°´æœ
        for (let i = 0; i < 8 - column.length; i++) {
          board[i][j] = getRandomFruit();
          newFruits.push({ row: i, col: j });
        }
      }
      
      return newFruits;
    }
    

    
    // æ˜¾ç¤ºè¿å‡»æ–‡å­—
    function showComboText(text) {
      const comboElement = document.createElement('div');
      comboElement.className = 'combo-text';
      comboElement.textContent = text;
      
      // éšæœºä½ç½®
      comboElement.style.left = `${Math.random() * 60 + 20}%`;
      comboElement.style.top = `${Math.random() * 40 + 30}%`;
      
      document.body.appendChild(comboElement);
      
      // åŠ¨ç”»ç»“æŸåç§»é™¤
      setTimeout(() => {
        if (document.body.contains(comboElement)) {
          document.body.removeChild(comboElement);
        }
      }, 1000);
    }
    
    // ä¼˜åŒ–çš„å¯èƒ½ç§»åŠ¨æ£€æŸ¥
    function hasPossibleMoves() {
      // æ£€æŸ¥æ¯ä¸ªä½ç½®çš„æ‰€æœ‰å¯èƒ½äº¤æ¢
      for (let i = 0; i < 8; i++) {
        for (let j = 0; j < 8; j++) {
          // æ£€æŸ¥å³è¾¹äº¤æ¢
          if (j < 7 && canSwapAndMatch(i, j, i, j + 1)) {
            return true;
          }
          
          // æ£€æŸ¥ä¸‹è¾¹äº¤æ¢
          if (i < 7 && canSwapAndMatch(i, j, i + 1, j)) {
            return true;
          }
        }
      }
      
      return false;
    }
    
    // æ£€æŸ¥äº¤æ¢æ˜¯å¦èƒ½äº§ç”ŸåŒ¹é…
    function canSwapAndMatch(row1, col1, row2, col2) {
      // æ‰§è¡Œäº¤æ¢
      swapCells(row1, col1, row2, col2);
      
      // æ£€æŸ¥æ˜¯å¦æœ‰åŒ¹é…
      const hasMatch = hasMatches();
      
      // äº¤æ¢å›æ¥
      swapCells(row1, col1, row2, col2);
      
      return hasMatch;
    }
    
    // ä¼˜åŒ–çš„æ¸¸æˆçŠ¶æ€æ£€æŸ¥
    function checkGameState() {
      // å»¶è¿Ÿæ£€æŸ¥ï¼Œç¡®ä¿æ‰€æœ‰åŠ¨ç”»å®Œæˆ
      setTimeout(() => {
        if (!hasPossibleMoves() && !isProcessing) {
          gameEnded = true;
          document.getElementById('finalScore').textContent = score;
          document.getElementById('finalMoves').textContent = moves;
          
          // å»¶è¿Ÿæ˜¾ç¤ºæ¸¸æˆç»“æŸç•Œé¢
          setTimeout(() => {
            document.getElementById('gameOver').style.display = 'flex';
          }, 500);
        }
      }, 300);
    }
    
    // ä¿å­˜æœ€é«˜åˆ†
    function saveHighScore() {
      localStorage.setItem('candycrush-highScore', highScore.toString());
    }
    
    // åŠ è½½æœ€é«˜åˆ†
    function loadHighScore() {
      const saved = localStorage.getItem('candycrush-highScore');
      if (saved) {
        highScore = parseInt(saved);
        document.getElementById('highScore').textContent = highScore;
      } else {
        highScore = 0;
        document.getElementById('highScore').textContent = highScore;
      }
    }
    
    // åˆå§‹åŒ–æ¸¸æˆ
    init();
  </script>
</body>
</html>